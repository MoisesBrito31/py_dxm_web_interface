{% extends 'base.html' %}
{% load static %}
{% block context %}

<script src="{% static 'js/moment.js'%}"></script>
<script src="{% static 'js/Chart.min.js'%}"></script>
<script src="{% static 'js/Chart.js'%}"></script>
<script src="{% static 'js/chart.util.js'%}"></script>

<div class="card-title mt-5 mb-3 pt-3">
    <div class="row">
        <div class="col text-left"><h2>{{linha}} - Grafico V</h2></div>

        <div class="col text-right">
            <div class="btn-group">
                <button type="button" class="btn btn-primary" onclick="window.location.href='/oee/overview'">fábrica</button>
                <button type="button" class="btn btn-primary" onclick="window.location.href='/oee/index/{{conjunto}}'">ao vivo</button>
                <button type="button" class="btn btn-primary disabled">Histórico</button>
                <!--<button type="button" class="btn btn-danger">Zerar</button>-->
            </div>
        </div>
    </div>

</div>
<form method="post" action="/oee/grafico_v/{{linhaIndex}}">
    {% csrf_token %}
    <div class="m-auto mt-5 form-inline form-group">
        <label>data:</label>
        <input type="date" class="form-control mr-3" name="ini" id="ini" value="{{inis}}" />
        <label>turno</label>
        
        <select class="form-control mr-3" id="turno" name="turno">
            {% for l in turnoList %}
            <option value="{{l}}" {% if turno == l %} selected="selected" {% endif %}>{{l}}</option>
            {% endfor %}
        </select>
        <button id="butBuscar" type="submit" class="btn btn-primary mr-3">Aplicar</button>
        <button  type="button" class="btn btn-primary mr-3" onclick="toggleAoVivo()">
            <span id="butAovivo">Ao Vivo</span>
        </button>
        <span id="splint" class="spinner-border spinner-border-sm" style="visibility:collapse"></span>
        <!--<button type="button" class="btn btn-primary" onclick="gerarRelatorio()">Relatório</button>-->
    </div>
</form>


<hr>
<div class="container-fluid m-auto">

    
    <div class="m-auto" style="width:80%;">
        <canvas id="canvas"></canvas>
    </div>
    
    <hr />
   
</div>

<script>
        var roda = document.getElementById("splint");
        var butAovivo = document.getElementById("butAovivo");
        var butBuscar = document.getElementById("butBuscar");
        var aovivo = false
        var aovioData_vel_atu = []
        var aovioData_vel_esp = []
		var config = {
			type: 'line',
			data: {
                labels: [
                    {% for equi in equipamentos %}
                    '{{equi.nome}}',
                    {% endfor %}
                ],
				datasets: [{
                    label: 'Atual (p/m)',
					backgroundColor: window.chartColors.blue,
					borderColor: window.chartColors.blue,
					data: [
                        {% for v in dados %}
                        {{v.valor}},
                        {% endfor %}
                    ],
					fill: false,
				},{
                label: 'Esperado (p/m)',
					backgroundColor: window.chartColors.red,
					borderColor: window.chartColors.red,
					data: [
                        {% for e in esp %}
                        {{e}},
                        {% endfor %}
                    ],
					fill: false,
				}]
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: '{{turno}} com fechamento {{data}}'
				},
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Equipamento'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Velocidade Media'
						}
					}]
				}
			}
		};

        setTimeout(function(){
            var ctx = document.getElementById('canvas').getContext('2d');
			window.myLine = new Chart(ctx, config);
        },500)

        setInterval(function(){
            if (aovivo == true){
                getAoVivo()
            }
        },5000)

        function toggleAoVivo(){
            aovivo = !aovivo
            if (aovivo == false){
                roda.setAttribute("style","visibility:collapse")
                butBuscar.removeAttribute("disabled")
                butAovivo.innerHTML = "Ao vivo"
            }else{
                getAoVivo()
                 roda.setAttribute("style","visibility:visible")
                 butBuscar.setAttribute("disabled","true")
                 butAovivo.innerHTML = "OFF"
            }
        }

        function getAoVivo() {
            aovioData_vel_atu = []
            aovioData_vel_esp = []
         
            
                    
                      var xhp = new XMLHttpRequest()
        xhp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                data = JSON.parse(this.responseText)
                data.forEach(ele => {
                    aovioData_vel_atu.push(ele.vel_atu)
                    aovioData_vel_esp.push(ele.vel_esp)
                });
                
                
                myLine.data.datasets[0].data = aovioData_vel_esp
                myLine.data.datasets[1].data = aovioData_vel_atu
                console.log(aovioData_vel_atu)
                console.log(aovioData_vel_esp)       
                myLine.update() 
                }
            }
        
        xhp.open("Get", "/oee/get_v_aovivo/{{conjunto}}");
        xhp.send();
       
        
    }

        var colorNames = Object.keys(window.chartColors);

        function gerarRelatorio() {
        var ini = document.getElementById("ini").value
        var fim = document.getElementById("fim").value
        var xhp = new XMLHttpRequest()
        var endres = `/oee/relatorio/${ini}/${fim}/{{linha_id}}`
        document.location.href=endres
    }

</script>

{% endblock %}