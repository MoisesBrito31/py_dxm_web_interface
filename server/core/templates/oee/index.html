{% extends 'base.html' %}
{% load static %}
{% block context %}

<div class="card-title mt-5 mb-5">
    <div class="row">
        <div class="col text-left">
            <h2>Fábrica Visão Geral</h2>
        </div>
    </div>
</div>



<hr>
<div class="container-fluid row m-auto">
    {{ dados.linhas }}
    



</div>



<script>
    var data;
    var gage = []

    function linhaAltera() {
        var valor = document.getElementById("linhas").value
        var xhp = new XMLHttpRequest()
        
        xhp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                var re = this.responseText
                document.location.reload()
            }
        }
        xhp.open("Get", "/oee/setLinhas?valor=" + valor);
        xhp.send();
    }

    function emula(valor) {
        
        if (valor == 0) {
            valor=1
        }
        else {
            valor=0
        }       

        var xhp = new XMLHttpRequest()
        xhp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                var re = this.responseText
               document.location.reload()
            }
        }
        xhp.open("Get", "/oee/emula?valor="+valor);
        xhp.send();
    }



    var sectors = [{
        color: "#c00002",
        lo: 0,
        hi: 20,
    }, {
        color: "#febf00",
        lo: 20,
        hi: 40,
    }, {
        color: "#fdf500",
        lo: 40,
        hi: 60,
    }, {
        color: "#92d14f",
        lo: 60,
        hi: 80,
    }, {
        color: "#00af50",
        lo: 80,
        hi: 100,
    }];

    var linhas = {{dados.quantidade}}



    for(var x = 0; x < linhas; x++) {
        var a = new JustGage({
            id: (x).toString(),
            value: 0,
            min: 0,
            max: 100,
            title: "OEE",
            symbol: '%',
            pointer: true,
            customSectors: sectors,
            relativeGaugeSize: true
        })
        gage.push(a)

    }





    setInterval(function () {
        getlinhas()
        getTurno()
        }, 1000)

    function getlinhas() {
        var xhp = new XMLHttpRequest()
        xhp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                var re = this.responseText
                data = JSON.parse(re);
                if (data[0].estado == "DXM OffLine") {
                    document.location.href = "/oee/offline";
                }
                else {
                    for (x = 0; x < data.length; x++) {
                        document.getElementById(`l ${x}`).innerHTML = data[x].nome
                        document.getElementById(`p ${x}`).innerHTML = data[x].estado                        
                        gage[x].refresh(data[x].oee)
                    }
                }

            }
        }
        xhp.open("Get", "/oee/conjunto_linhas");
        xhp.send();
    }

    function getTurno() {
        var xhp = new XMLHttpRequest()
        xhp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                var re = this.responseText
                document.getElementById("turno").innerHTML = re;
            }
        }
        xhp.open("Get", "/oee/getTurno");
        xhp.send();
    }

    

    setInterval(function () {
         for (x = 0; x < data.length; x++) {                       
                  if (data[x].estado == "Operando") {
                      document.getElementById(`p ${x}`).setAttribute("style", "color:green")
                      document.getElementById(`b ${x}`).setAttribute("class", "bg-light text-center border rounded mb-5 p-2")
                  }
                  if (data[x].estado == "Parada") {
                     
                      if (document.getElementById(`b ${x}`).getAttribute("class") == "bg-light text-center border rounded mb-5 p-2") {
                          document.getElementById(`b ${x}`).setAttribute("class", "bg-danger text-center border rounded mb-5 p-2")
                           document.getElementById(`p ${x}`).setAttribute("style", "color:white")
                      }
                      else {
                          document.getElementById(`b ${x}`).setAttribute("class", "bg-light text-center border rounded mb-5 p-2")
                           document.getElementById(`p ${x}`).setAttribute("style", "color:red")
                      }
                      
                  }
                  
              }
    }, 500)

</script>

{% endblock %}